class Maps{constructor(){this.list=[{levelID:1,map:[[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0]],player:{position:{row:3,cell:2}},interactables:{exits:[{position:{row:3,cell:8}}]}},{levelID:2,map:[[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0]],player:{position:{row:3,cell:2}},interactables:{exits:[{position:{row:3,cell:8}}]}},{levelID:3,map:[[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,1,0,0,0,0,0]],player:{position:{row:3,cell:2}},interactables:{pushBlocks:[{type:"default",position:{row:0,cell:5}}],exits:[{position:{row:3,cell:8}}]}},{levelID:4,map:[[2,2,2,2,2,1,2,2,2,2,2],[2,2,2,2,2,1,2,2,2,2,2],[2,2,2,0,0,1,0,0,2,2,2],[2,2,2,0,0,0,0,0,2,2,2],[2,2,2,0,0,1,0,0,2,2,2],[2,2,2,2,2,1,2,2,2,2,2],[2,2,2,2,2,1,2,2,2,2,2]],player:{position:{row:3,cell:1}},interactables:{pushBlocks:[{type:"default",position:{row:3,cell:5}}],pushBlockHomes:[{position:{row:3,cell:5}}],exits:[{position:{row:3,cell:9}}]}},{levelID:5,map:[[0,0,1,1,1,1,1,1,1,1,1],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,2,0,2,0,0],[0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,2,0,2,0,1],[0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,0,0,1]],player:{position:{row:3,cell:7}},interactables:{pushBlocks:[{type:"default",position:{row:5,cell:7}}],pushBlockHomes:[{position:{row:3,cell:7}}],exits:[{position:{row:5,cell:7}}]}},{levelID:6,map:[[0,0,0,0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,0,1,1,0],[0,1,0,0,0,0,0,0,0,1,0],[0,1,0,0,0,0,0,0,0,1,0],[0,1,1,0,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0]],player:{position:{row:6,cell:5}},interactables:{pushBlocks:[{type:"default",position:{row:4,cell:3}},{type:"default",position:{row:1,cell:7}}],pushBlockHomes:[{position:{row:4,cell:3}},{position:{row:1,cell:7}}],exits:[{position:{row:3,cell:5}}]}},{levelID:7,map:[[0,0,0,1,0,2,0,0,0,0,0],[2,0,0,0,0,1,0,0,0,0,0],[1,2,0,0,2,1,0,0,0,0,0],[0,1,1,0,0,1,0,0,0,0,0],[0,0,1,0,0,1,0,0,0,0,0],[0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0]],player:{position:{row:6,cell:10}},interactables:{pushBlocks:[{type:"default",position:{row:2,cell:2}},{type:"default",position:{row:3,cell:3}},{type:"default",position:{row:4,cell:4}},{type:"default",position:{row:0,cell:6}}],pushBlockHomes:[{position:{row:2,cell:2}},{position:{row:3,cell:3}},{position:{row:4,cell:4}},{position:{row:0,cell:10}}],exits:[{position:{row:6,cell:10}}]}},{levelID:8,map:[[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0]],player:{position:{row:2,cell:2}},interactables:{pushBlocks:[{type:"default",position:{row:4,cell:2}}],exits:[{position:{row:3,cell:8}}],laserEmitters:[{position:{row:0,cell:5},direction:"down"}]}},{levelID:9,map:[[0,0,0,1,0,0,0,1,0,0,0],[0,0,0,1,2,2,0,1,0,0,0],[0,0,0,1,2,0,0,0,0,0,0],[0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,1,0,0,0],[0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,1,0,0,0]],player:{position:{row:5,cell:1}},interactables:{pushBlocks:[{type:"default",position:{row:1,cell:1}},{type:"default",position:{row:2,cell:1}},{type:"default",position:{row:3,cell:1}}],exits:[{position:{row:5,cell:9}}],laserEmitters:[{position:{row:0,cell:4},direction:"down"},{position:{row:0,cell:5},direction:"down"},{position:{row:0,cell:6},direction:"down"}]}},{levelID:10,map:[[1,0,0,0,0,1,0,0,0,0,0],[0,0,1,0,0,0,0,2,0,0,0],[0,0,0,0,0,2,0,0,0,0,0],[1,0,1,0,2,0,2,1,0,0,0],[0,0,1,2,1,1,0,0,2,1,1],[0,0,0,0,0,0,0,0,0,0,0],[0,0,1,1,1,1,1,1,1,1,1]],player:{position:{row:1,cell:6}},interactables:{pushBlocks:[{type:"default",position:{row:5,cell:6}},{type:"default",position:{row:1,cell:9}}],pushBlockHomes:[{position:{row:5,cell:10}},{position:{row:1,cell:8}}],exits:[{position:{row:1,cell:10}}],laserEmitters:[{position:{row:0,cell:8},direction:"down"}]}},{levelID:11,map:[[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0]],player:{position:{row:4,cell:5}},interactables:{pushBlocks:[{type:"default",position:{row:3,cell:5}}],exits:[{position:{row:1,cell:10}}],laserEmitters:[{position:{row:1,cell:7},direction:"down"},{position:{row:5,cell:7},direction:"left"},{position:{row:1,cell:3},direction:"right"},{position:{row:5,cell:3},direction:"up"}]}}]}getByLevelID(e){for(let t of this.list)if(t.levelID===e)return t}}class Tiles{constructor(){this.mapTiles=[{id:0,name:"floor",colour:"#e5ddcb",obstructsPlayer:!1,obstructsPushBlock:!1,obstructsLaser:!1},{id:1,name:"wall",colour:"#bc6247",obstructsPlayer:!0,obstructsPushBlock:!0,obstructsLaser:!0},{id:2,name:"noBlockFloor",colour:"#d9d2c1",obstructsPlayer:!1,obstructsPushBlock:!0,obstructsLaser:!1}],this.playerTiles=[{id:0,name:"rover",colour:"#685e6c",obstructsPlayer:!0,obstructsPushBlock:!0,obstructsLaser:!0}],this.pushBlockTiles=[{id:0,name:"block",colour:"#eb7b59",obstructsPlayer:!0,obstructsPushBlock:!0,obstructsLaser:!0}],this.pushBlockHomeTiles=[{id:0,name:"pushBlockHome",colour:"#eb7b59",obstructsPlayer:!1,obstructsPushBlock:!1,obstructsLaser:!1}],this.exitTiles=[{id:0,name:"enabled",colour:"#685e6c",obstructsPlayer:!1,obstructsPushBlock:!1,obstructsLaser:!1},{id:1,name:"disabled",colour:"#c7c0b1",obstructsPlayer:!1,obstructsPushBlock:!1,obstructsLaser:!1}],this.laserTiles=[{id:0,name:"laserEmitter",colour:"#bc6247",detailColour:"#663627",obstructsPlayer:!0,obstructsPushBlock:!0}]}getByID(e,t){switch(e){case"map":return this.getMapTileByID(t);case"pushBlock":return this.getPushBlockTileByID(t)}}getMapTileByID(e){for(let t of this.mapTiles)if(t.id===e)return t}getPushBlockTileByID(e){for(let t of this.pushBlockTiles)if(t.id===e)return t}getPlayerTile(e=0){for(let t of this.playerTiles)if(t.id===e)return t}}class PushBlockTypes{constructor(){this.list=[{id:0,name:"default",tileID:0}]}getByName(e){for(let t of this.list)if(t.name===e)return t}}class MoveEntry{constructor(e,t,i,s,l,o,r,a,h,c){this.id=e,this.frame=t,this.entityType=i,this.entityID=s,this.fromRow=l,this.fromCell=o,this.toRow=r,this.toCell=a,this.speed=h,this.queued=c}}class Move{constructor(e){this.game=e,this.list=[],this.locked=!1}add(e,t,i,s,l,o,r){if(this.locked)return!1;if(i===l&&s===o)return!1;if(i!==l&&s!==o)return!1;var a=!1;this.isMoving(e,t)&&(a=!0);var h=this.list.length,c=new MoveEntry(h,this.game.tickFrame,e,t,i,s,l,o,r,a);this.list.push(c)}lock(){this.locked=!0}unlock(){this.locked=!1}getCurrentPosition(e,t){var i=this.getEarliestMovement(e,t);if(void 0===i)return!1;var s=this.game.tickFrame-i.frame,l=i.speed*s;return l+i.speed>=100&&this.removeEntry(i.id),{fromRow:i.fromRow,fromCell:i.fromCell,toRow:i.toRow,toCell:i.toCell,percentage:l}}isMoving(e,t){return!1!==this.getCurrentPosition(e,t)}getEarliestMovement(e,t){for(let i of this.list)if(i.entityType===e&&i.entityID===t)return i}unqueueEarliestMovement(e,t){for(let i of this.list)if(i.entityType===e&&i.entityID===t&&!0===i.queued)return i.queued=!1,i.frame=this.game.tickFrame,!0}removeEntry(e){for(var t=0;t<this.list.length;t++){var i=this.list[t];if(i.id==e)return this.list.splice(t,1),this.unqueueEarliestMovement(i.entityType,i.entityID),!0}}}class Level{constructor(e,t=1){this.game=e,this.map=this.game.maps.getByLevelID(t)}locationAvailable(e,t,i){if(!this.locationExists(e,t))return!1;var s=this.getMapTile(e,t);if("player"===i&&s.obstructsPlayer||"pushBlock"===i&&s.obstructsPushBlock||"laser"===i&&s.obstructsLaser)return!1;if(("laser"===i||"pushBlock"===i)&&this.game.pushBlocks.getBlockByLocation(e,t))return!1;if(void 0!==this.map.interactables&&void 0!==this.map.interactables.laserEmitters)for(let i of this.map.interactables.laserEmitters)if(i.position.row===e&&i.position.cell===t)return!1;return!0}locationExists(e,t){return void 0!==this.map.map[e]&&void 0!==this.map.map[e][t]}getMapTile(e,t){if(!this.locationExists(e,t))return!1;var i=this.map.map[e][t];return this.game.tiles.getByID("map",i)}getNextAvailablePositionForDirection(e,t,i,s){var l=t,o=i;switch(e){case"up":t-=1;break;case"down":t+=1;break;case"left":i-=1;break;case"right":i+=1}return this.locationAvailable(t,i,s)?{row:t,cell:i}:{row:l,cell:o}}complete(){this.game.move.lock(),this.game.queueNextLevel()}}class Player{constructor(e){this.game=e,this.position={row:e.level.map.player.position.row,cell:e.level.map.player.position.cell},this.speed=25}move(e){var t,i=this.game.level.getNextAvailablePositionForDirection(e,this.position.row,this.position.cell,"player");if(i.row===this.position.row&&i.cell===this.position.cell)return!1;(t=this.game.pushBlocks.getBlockByLocation(i.row,i.cell))?this.game.pushBlocks.moveBlock(e,t.id)&&(this.game.move.add("player",0,this.position.row,this.position.cell,i.row,i.cell,this.speed),this.position.row=i.row,this.position.cell=i.cell):(this.game.move.add("player",0,this.position.row,this.position.cell,i.row,i.cell,this.speed),this.position.row=i.row,this.position.cell=i.cell),this.checkAlive(),this.game.exit.found()&&this.game.level.complete()}checkAlive(){this.game.laser.laserExists(this.position.row,this.position.cell)&&this.game.restartLevel()}}class PushBlock{constructor(e,t,i,s){this.id=e,this.row=t,this.cell=i,this.tile=s}}class PushBlocks{constructor(e){if(this.game=e,this.list=[],this.allPushBlocksHome=!1,void 0!==this.game.level.map.interactables&&void 0!==this.game.level.map.interactables.pushBlocks){for(let e of this.game.level.map.interactables.pushBlocks)this.add(e.type,e.position.row,e.position.cell);this.checkAllPushBlocksHome()}else this.allPushBlocksHome=!0}add(e,t,i){var s=this.list.length,l=this.game.pushBlockTypes.getByName(e),o=this.game.tiles.getByID("pushBlock",l.tileID),r=new PushBlock(s,t,i,o);this.list.push(r)}getBlockByLocation(e,t){for(let i of this.list)if(i.row===e&&i.cell===t)return i}moveBlock(e,t){for(let s of this.list)if(s.id===t){var i=this.game.level.getNextAvailablePositionForDirection(e,s.row,s.cell,"pushBlock");return(i.row!==s.row||i.cell!==s.cell)&&(!this.getBlockByLocation(i.row,i.cell)&&(this.game.move.add("pushBlock",s.id,s.row,s.cell,i.row,i.cell,this.game.player.speed),s.row=i.row,s.cell=i.cell,this.checkAllPushBlocksHome()?this.game.exit.enable():this.game.exit.disable(),!0))}return!1}checkAllPushBlocksHome(){if(void 0===this.game.level.map.interactables.pushBlockHomes)return this.allPushBlocksHome=!0,!0;for(let e of this.list)if(!this.checkPushBlockHome(e))return this.allPushBlocksHome=!1,!1;return this.allPushBlocksHome=!0,!0}checkPushBlockHome(e){for(let t of this.game.level.map.interactables.pushBlockHomes)if(t.position.row===e.row&&t.position.cell===e.cell)return!0}}class Exit{constructor(e){this.game=e,this.game.pushBlocks.allPushBlocksHome?this.enable():this.disable()}found(){var e=this.game.player.position;if(!1===this.enabled)return!1;for(let t of this.game.level.map.interactables.exits)if(t.position.row===e.row&&t.position.cell===e.cell)return!0}enable(){this.enabled=!0,this.tile=this.game.tiles.exitTiles[0]}disable(){this.enabled=!1,this.tile=this.game.tiles.exitTiles[1]}}class Laser{constructor(e){this.game=e,this.emitters=[],this.lasers=[],this.addEmitters(),this.emitLasers()}addEmitters(){if(void 0===this.game.level.map.interactables||void 0===this.game.level.map.interactables.laserEmitters)return!1;for(let e of this.game.level.map.interactables.laserEmitters)e.id=this.emitters.length,this.emitters.push(e)}emitLasers(){this.lasers=[];for(let e of this.emitters)this.emitLaserFromEmitter(e.id)}laserExists(e,t){this.emitLasers();for(let i of this.lasers)if(i.row===e&&i.cell===t)return!0}emitLaserFromEmitter(e){var t=this.getEmitterByID(e);this.emitLaserFrom(t.position.row,t.position.cell,t.direction)}emitLaserFrom(e,t,i){switch(i){case"down":e+=1;break;case"up":e-=1;break;case"left":t-=1;break;case"right":t+=1}if(!this.game.level.locationAvailable(e,t,"laser"))return!1;this.lasers.push({row:e,cell:t,direction:i}),this.emitLaserFrom(e,t,i)}getEmitterByID(e){for(let t of this.emitters)if(t.id===e)return t}}class Controls{constructor(e){this.game=e,this.listen()}listen(){var e=this;window.addEventListener("keydown",function(t){e.keyDown(t)})}keyDown(e){switch(e.keyCode){case 87:case 38:this.game.player.move("up");break;case 83:case 40:this.game.player.move("down");break;case 65:case 37:this.game.player.move("left");break;case 68:case 39:this.game.player.move("right");break;case 32:this.game.restartLevel();break;case 221:this.game.loadNextLevel()}}}class Canvas{constructor(e){this.game=e,this.tileSize=64,this.c=document.getElementById("canvas"),this.ctx=this.c.getContext("2d"),this.setDimensions()}setDimensions(){this.c.height=this.c.clientHeight,this.c.width=this.c.clientWidth}drawFrame(){this.drawLevel(),this.drawPlayer()}drawLevel(){this.drawMap(),this.drawExits(),this.drawPushBlockHomes(),this.drawLasers(),this.drawPushBlocks()}drawPlayer(){var e=this.game.tiles.getPlayerTile(),t=this.game.player.position.row*this.tileSize,i=this.game.player.position.cell*this.tileSize,s=this.game.move.getCurrentPosition("player",0);if(!1!==s){t=s.toRow*this.tileSize,i=s.toCell*this.tileSize;if(s.fromRow!==s.toRow){var l=s.fromRow*this.tileSize;t=l>s.toRow*this.tileSize?l-this.tileSize/100*s.percentage:l+this.tileSize/100*s.percentage}else{var o=s.fromCell*this.tileSize;i=o>s.toCell*this.tileSize?o-this.tileSize/100*s.percentage:o+this.tileSize/100*s.percentage}}this.drawTile(e.colour,t,i)}drawMap(){for(var e=this.game.level.map,t=0;t<e.map.length;t++)for(var i=e.map[t],s=0;s<i.length;s++){var l=i[s];this.drawMapTile(l,t,s)}}drawPushBlocks(){for(let o of this.game.pushBlocks.list){var e=o.row*this.tileSize,t=o.cell*this.tileSize,i=this.game.move.getCurrentPosition("pushBlock",o.id);if(!1!==i){e=i.toRow*this.tileSize,t=i.toCell*this.tileSize;if(i.fromRow!==i.toRow){var s=i.fromRow*this.tileSize;e=s>i.toRow*this.tileSize?s-this.tileSize/100*i.percentage:s+this.tileSize/100*i.percentage}else{var l=i.fromCell*this.tileSize;t=l>i.toCell*this.tileSize?l-this.tileSize/100*i.percentage:l+this.tileSize/100*i.percentage}}this.drawTile(o.tile.colour,e,t)}}drawPushBlockHomes(){if(void 0===this.game.level.map.interactables||void 0===this.game.level.map.interactables.pushBlockHomes)return!1;for(let s of this.game.level.map.interactables.pushBlockHomes){var e=s.position.row*this.tileSize,t=s.position.cell*this.tileSize,i=this.game.tiles.pushBlockHomeTiles[0].colour;this.drawTileOutline(i,e,t)}}drawExits(){for(let s of this.game.level.map.interactables.exits){var e=s.position.row*this.tileSize,t=s.position.cell*this.tileSize,i=this.game.exit.tile.colour;this.drawTileOutline(i,e,t)}}drawLasers(){this.drawLaserEmitters(),this.drawLaserLines()}drawLaserLines(){for(let e of this.game.laser.lasers)this.drawTileLine(e.direction,this.tileSize/11,"#c00",e.row*this.tileSize,e.cell*this.tileSize)}drawLaserEmitters(){if(void 0===this.game.level.map.interactables||void 0===this.game.level.map.interactables.laserEmitters)return!1;for(let s of this.game.level.map.interactables.laserEmitters){var e=s.position.row*this.tileSize,t=s.position.cell*this.tileSize,i=this.game.tiles.laserTiles[0];this.drawLaserEmitter(i.colour,i.detailColour,e,t,s.direction)}}tileSizePercent(e){return e/100*this.tileSize}drawLaserEmitter(e,t,i,s,l){switch(this.drawTile(e,i,s),this.ctx.fillStyle=t,this.ctx.beginPath(),l){case"up":this.ctx.moveTo(s+this.tileSizePercent(50),i+this.tileSizePercent(20)),this.ctx.lineTo(s+this.tileSizePercent(33),i),this.ctx.lineTo(s+this.tileSizePercent(66),i);break;case"down":this.ctx.moveTo(s+this.tileSizePercent(50),i+this.tileSizePercent(80)),this.ctx.lineTo(s+this.tileSizePercent(33),i+this.tileSize),this.ctx.lineTo(s+this.tileSizePercent(66),i+this.tileSize);break;case"left":this.ctx.moveTo(s+this.tileSizePercent(20),i+this.tileSizePercent(50)),this.ctx.lineTo(s,i+this.tileSizePercent(33)),this.ctx.lineTo(s,i+this.tileSizePercent(66));break;case"right":this.ctx.moveTo(s+this.tileSizePercent(80),i+this.tileSizePercent(50)),this.ctx.lineTo(s+this.tileSize,i+this.tileSizePercent(33)),this.ctx.lineTo(s+this.tileSize,i+this.tileSizePercent(66))}this.ctx.fill()}drawMapTile(e,t,i){if(void 0===e)return!1;var s=this.game.tiles.getByID("map",e),l=t*this.tileSize,o=i*this.tileSize;this.drawTile(s.colour,l,o)}drawTile(e,t,i){this.ctx.fillStyle=e,this.ctx.fillRect(i,t,this.tileSize,this.tileSize)}drawTileLine(e,t,i,s,l){this.ctx.strokeStyle=i,this.ctx.lineWidth=t,this.ctx.beginPath(),"up"===e||"down"===e?(this.ctx.moveTo(l+this.tileSize/2,s),this.ctx.lineTo(l+this.tileSize/2,s+this.tileSize)):(this.ctx.moveTo(l,s+this.tileSize/2),this.ctx.lineTo(l+this.tileSize,s+this.tileSize/2)),this.ctx.stroke()}drawTileOutline(e,t,i,s=this.tileSize/11){this.ctx.strokeStyle=e,this.ctx.lineWidth=s,this.ctx.strokeRect(i+s,t+s,this.tileSize-2*s,this.tileSize-2*s)}}class Game{constructor(){this.maps=new Maps,this.tiles=new Tiles,this.pushBlockTypes=new PushBlockTypes,this.move=new Move(this),this.level=new Level(this),this.player=new Player(this),this.pushBlocks=new PushBlocks(this),this.exit=new Exit(this),this.laser=new Laser(this),this.controls=new Controls(this),this.canvas=new Canvas(this),this.tickFrame=0,this.nextLevelQueued=!1}run(){var e=this;this.loop=setInterval(function(){e.tick()},42)}tick(){this.tickFrame++,this.canvas.drawFrame(),this.nextLevelQueued&&0===this.move.list.length&&this.loadNextLevel()}queueNextLevel(){this.nextLevelQueued=!0}loadNextLevel(){this.nextLevelQueued=!1;var e=this.level.map.levelID+1;this.maps.getByLevelID(e)||(e=1),this.loadLevel(e)}restartLevel(){this.loadLevel(this.level.map.levelID)}loadLevel(e){this.move=new Move(this),this.level=new Level(this,e),this.player=new Player(this),this.pushBlocks=new PushBlocks(this),this.exit=new Exit(this),this.laser=new Laser(this),this.canvas=new Canvas(this)}}var game=new Game;game.run();