class Maps{constructor(e){this.game=e,this.list=[{levelID:1,name:"Hello, World!",code:"11a100011100010x13ap0x6ae0x14a10001110001"},{levelID:2,name:"What does the fox say?",code:"11a100011100010x5a10x7ap000100e0x8a10x10a10x16a10x9a1"},{levelID:3,name:"Aye!",code:"11a100011100010x5a10x10ab0x11a10x7ap000100e0x8a10x5a10001110001"},{levelID:4,name:"Derpy",code:"11a122211122212x5a12x8a001002222p2200hb0002e2x5a001002x8a12x5a12221112221"},{levelID:5,name:"Ninja",code:"7a1001x5a0x8a2020x5aph00011020201100eb0001x5a001"},{levelID:6,name:"Hermit",code:"11a0x12a1x6ahb0110010x7a1001000e000010011hb01x6a0x12a10000p0x5a11110x5a111"},{levelID:7,name:"Going in circles",code:"12a00010x11ahb000010000101b01x6ahb01000h0000200b0x5a1000100h001x9a0x6ab0000h020pe0x5a1110x6a"},{levelID:8,name:"Destroy them with lasers!",code:"11a10001l0100010x13ap0x17ae0x5ab0x20a10001110001"},{levelID:9,name:"Clear a path",code:"11a1111l0l0l01x8a22010x6a120000e000b00100010000b0010001111000b000011110p0x6a11110001x8a"},{levelID:10,name:"Scenic route",code:"11a10000100l0x5a1000p02h0b0e0x6a20x5a10102021011001211002110x6ab0000h0001x9a"},{levelID:11,name:"Push past the pain",code:"11a00l000100bl0000b000b0x28a1p00100lu00010e0"},{levelID:12,name:"Slider",code:"11a0x10a101x8a0120x7abl02012x7a0ll0x6ab0x8a10111b01010e0x6a2100ph0"},{levelID:13,name:"The box",code:"9a10x7a10blr0000bl0x6ah00h0x8ahb0000e0000h0p0h0x6ablu0000bll000010x7a1"},{levelID:14,name:"Diamonds and guns",code:"9a111101x7a0001x5a00bc00011100101001001000ll0001001010011100pe0001x5a0001x7a01111"},{levelID:15,name:"Simple",code:"7a0x14a1bc0x6a10000hbll0110x5a1110pe00011100011"},{levelID:16,name:"A problem shared...",code:"8a110x5a10bc0x6a10bc02000bll01010010000e00010p00lr00001000"},{levelID:17,name:"Upon reflection...",code:"9a1111bc01x5a0x7a110x7a1blr0x8a110bml0000pe00110x7a1x10a"},{levelID:18,name:"Wraparound",code:"9a00010p21110bm0000b001100110bmr00010011100010001x6a0x7a112blu010bc00e00bm021x7a2bmu02x7abml0"},{levelID:19,name:"Bypass",code:"9a10x7a110bmr00e00bm00110x7a1blr0x8abc010x7a110bmu00p00bml00110x7a1"},{levelID:20,name:"Toggle",code:"9abmr0222bm0110e02x5a000022bl002bmr0bml0bmu00bmu02bml02bmu0000bc011101110110000100010x6ap00100001000"},{levelID:21,name:"Let this one slide",code:"9a120x6a10x5a20x14abs00h00pe020x5a2000020x8a10x5a201"},{levelID:22,name:"Gemini",code:"10a120x7a10x9a20x7a20020bs00pe000h0hbs0x10a20x9a2010020x5a1"},{levelID:23,name:"Pressing forward",code:"9a112x7a110x5abs001100102001122101221x5a0111000bc0202220pe00blr0x5a200012x5a"},{levelID:24,name:"The domino effect",code:"15a111101010101x6a00h00h00h00h00011110x11a1110000p00e00b0x5a110x13a10000bs00bs00bs00bs0x20a"}]}getByLevelID(e){for(let i of this.list)if(i.levelID===e){if(i.code){var t=this.game.encoder.decode(i.code);return t.levelID=i.levelID,t.name=i.name,t}return i}}}class Tiles{constructor(){this.mapTiles=[{id:0,name:"floor",colour:"#e5ddcb",obstructsPlayer:!1,obstructsPushBlock:!1,obstructsLaser:!1},{id:1,name:"wall",colour:"#bc6247",obstructsPlayer:!0,obstructsPushBlock:!0,obstructsLaser:!0},{id:2,name:"noBlockFloor",colour:"#d9d2c1",obstructsPlayer:!1,obstructsPushBlock:!0,obstructsLaser:!1}],this.playerTiles=[{id:0,name:"rover",colour:"#685e6c",obstructsPlayer:!0,obstructsPushBlock:!0,obstructsLaser:!0}],this.pushBlockTiles=[{id:0,name:"block",colour:"#eb7b59",obstructsPlayer:!0,obstructsPushBlock:!0,obstructsLaser:!0},{id:1,name:"laser",colour:"#eb7b59",obstructsPlayer:!0,obstructsPushBlock:!0,obstructsLaser:!0},{id:2,name:"laserCapture",colour:"#eb7b59",obstructsPlayer:!0,obstructsPushBlock:!0,obstructsLaser:!0},{id:3,name:"mirror",colour:"#eb7b59",detailColour:"#d9d2c1",obstructsPlayer:!0,obstructsPushBlock:!0,obstructsLaser:!0},{id:4,name:"slide",colour:"#eb7b59",detailColour:"#d9d2c1",obstructsPlayer:!0,obstructsPushBlock:!0,obstructsLaser:!0}],this.pushBlockHomeTiles=[{id:0,name:"pushBlockHome",colour:"#eb7b59",obstructsPlayer:!1,obstructsPushBlock:!1,obstructsLaser:!1}],this.exitTiles=[{id:0,name:"enabled",colour:"#685e6c",obstructsPlayer:!1,obstructsPushBlock:!1,obstructsLaser:!1},{id:1,name:"disabled",colour:"#c7c0b1",obstructsPlayer:!1,obstructsPushBlock:!1,obstructsLaser:!1}],this.laserTiles=[{id:0,name:"laserEmitter",colour:"#bc6247",obstructsPlayer:!0,obstructsPushBlock:!0}]}getByID(e,t){switch(e){case"map":return this.getMapTileByID(t);case"pushBlock":return this.getPushBlockTileByID(t)}}getMapTileByID(e){for(let t of this.mapTiles)if(t.id===e)return t}getMapTileByName(e){for(let t of this.mapTiles)if(t.name===e)return t}getPushBlockTileByID(e){for(let t of this.pushBlockTiles)if(t.id===e)return t}getPlayerTile(e=0){for(let t of this.playerTiles)if(t.id===e)return t}}class PushBlockTypes{constructor(){this.list=[{id:0,name:"default",tileID:0},{id:1,name:"laser",tileID:1},{id:2,name:"laserCapture",tileID:2},{id:3,name:"mirror",tileID:3},{id:4,name:"slide",tileID:4}]}getByName(e){for(let t of this.list)if(t.name===e)return t}}class Timer{constructor(){this.list=[]}count(e,t=0,i=!1){var s=this.get(e);return void 0===s?(s={reference:e,length:t,start:Date.now(),elapsed:0,elapsedPercent:0,remaining:t,remainingPercent:100,completed:!1,backwards:!1},this.list.push(s),s):(s.elapsed=Date.now()-s.start,s.elapsedPercent=Math.round(s.elapsed/s.length*100),s.remaining=s.length-s.elapsed,s.remainingPercent=Math.round(s.remaining/s.length*100),s.elapsed>=s.length&&(!1===i?(s.elapsed=s.length,s.elapsedPercent=100,s.remaining=0,s.remainingPercent=0,s.completed=!0,this.remove(s.reference)):(s.start=Date.now(),s.elapsed=0,s.elapsedPercent=0,s.remaining=t,s.remainingPercent=100,s.completed=!1,!0===s.backwards?s.backwards=!1:s.backwards=!0)),!0===s.backwards?{reference:s.reference,length:s.length,start:s.start,elapsed:s.remaining,elapsedPercent:s.remainingPercent,remaining:s.elapsed,remainingPercent:s.elapsedPercent,completed:!1,backwards:!0}:s)}get(e){for(let t of this.list)if(t.reference===e)return t}remove(e){var t=0;for(let i of this.list){if(i.reference===e)return this.list.splice(t,1),!0;t++}}}class Stats{constructor(e){this.game=e,this.levels=[]}add(){var e=this.levels[this.game.level.map.levelID],t=Date.now()-this.game.level.startTime;void 0!==e?(e.moves>this.game.level.moves&&(e.moves=this.game.level.moves),e.time>t&&(e.time=t)):this.levels[this.game.level.map.levelID]={moves:this.game.level.moves,time:t}}}class Move{constructor(e){this.game=e,this.list=[]}add(e,t,i){var s={id:this.getNewID(),entityType:e,entityID:t,direction:i};this.list.push(s)}getNewID(){var e=0;for(let t of this.list)t.id>e&&(e=t.id);return e+1}move(){this.movePlayer(),this.movePushBlocks()}movePlayer(){if(!game.exit.found()){var e=this.getEarliestMovement("player",0);if(void 0!==e){var t=this.game.player.move(e.direction);!0!==t&&!1!==t||this.removeEntry(e.id)}else{var i=this.game.controls.lastDirection;this.game.controls.directions.includes(i)&&this.add("player",0,i)}}}movePushBlocks(){for(let t of this.getEarliestPushBlockMovements()){var e=this.game.pushBlocks.moveBlock(t.direction,t.entityID);!0!==e&&!1!==e||this.removeEntry(t.id)}}getEarliestMovement(e,t){for(let i of this.list)if(i.entityType===e&&i.entityID===t)return i}getEarliestPushBlockMovements(){var e=[],t=[];for(let i of this.list)"pushBlock"!==i.entityType||e.includes(i.entityID)||(e.push(i.entityID),t.push(i));return t}removeEntry(e){var t=0;for(let i of this.list){if(i.id===e)return this.list.splice(t,1),!0;t++}}clear(){this.list=[]}}class Encoder{constructor(e){this.game=e}encode(e){for(var t=e.map[0].length+"a",i=null,s=0,l=!0,a=0;a<e.map.length;a++)for(var o=0;o<=e.map[a].length;o++)if(!(o===e.map[a].length&&a+1<e.map.length)){var h=e.map[a][o],r=this.getEntitiesAtTile(e,a,o);if(i!==h&&null!==i||0!==r.length){!0===l&&(l=!1,s-=1),s<0||(t+=0===s?i:s<=3?i.toString().repeat(s+1):i+"x"+(s+1)+"a");for(let e of r)t+=e;s=0}else s++;i=h}return t}decode(e){var t=/^[0-9]+/.exec(e)[0],i={position:{row:null,cell:null}},s={position:{row:null,cell:null}},l=[],a=[],o=[];for(e=e.slice(t.length+1);e.includes("x");){var h=/([0-9])\x([0-9]+)/.exec(e);e=e.slice(0,h.index)+h[1].repeat(h[2])+e.slice(h.index+h.length+1)}for(var r=[],c=[],n=0,m=0;e.length>0;){var d=e[0];if(isNaN(d)){if("a"===d){e=e.slice(1);continue}if("p"===d)i.position.row=m,i.position.cell=n,e=e.slice(1);else if("e"===d)s.position.row=m,s.position.cell=n,e=e.slice(1);else if("b"===d){var p="default",u=0;switch(f=e[1]){case"l":case"m":switch(p="l"==f?"laser":"mirror",e[2]){case"l":u=90;break;case"u":u=180;break;case"r":u=270}break;case"c":p="laserCapture";break;case"s":p="slide"}e="default"==p?e.slice(1):0==u?e.slice(2):e.slice(3),l.push({position:{row:m,cell:n},orientation:u,type:p})}else if("h"===d)a.push({position:{row:m,cell:n}}),e=e.slice(1);else if("l"===d){var f,g="down";switch(f=e[1]){case"l":g="left";break;case"r":g="right";break;case"u":g="up"}e="down"==g?e.slice(1):e.slice(2),o.push({position:{row:m,cell:n},direction:g})}if(isNaN(e[0]))continue}c.push(parseInt(e[0])),e=e.slice(1),n+1==t?(r.push(JSON.parse(JSON.stringify(c))),c=[],m++,n=0):n++}var v={map:r,player:i,interactables:{exits:[s]}};return l.length>0&&(v.interactables.pushBlocks=l),a.length>0&&(v.interactables.pushBlockHomes=a),o.length>0&&(v.interactables.laserEmitters=o),v}getEntitiesAtTile(e,t,i){var s=[];if(e.player.position.row===t&&e.player.position.cell===i&&s.push("p"),e.interactables.exits[0].position.row===t&&e.interactables.exits[0].position.cell===i&&s.push("e"),e.interactables.pushBlockHomes)for(let l of e.interactables.pushBlockHomes)l.position.cell===i&&l.position.row===t&&s.push("h");if(e.interactables.laserEmitters)for(let l of e.interactables.laserEmitters)if(l.position.cell===i&&l.position.row===t)switch(l.direction){case"down":s.push("l");break;case"up":s.push("lu");break;case"left":s.push("ll");break;case"right":s.push("lr")}if(e.interactables.pushBlocks)for(let l of e.interactables.pushBlocks)if(l.position.cell===i&&l.position.row===t)switch(l.type){case"default":s.push("b");break;case"laser":switch(l.orientation){case 90:s.push("bll");break;case 180:s.push("blu");break;case 270:s.push("blr");break;default:s.push("bl")}break;case"mirror":switch(l.orientation){case 90:s.push("bml");break;case 180:s.push("bmu");break;case 270:s.push("bmr");break;default:s.push("bm")}break;case"laserCapture":s.push("bc");break;case"slide":s.push("bs")}return s}}class Level{constructor(e,t=1){if(this.game=e,this.begin=!0,this.moves=0,this.startTime=Date.now(),0===t){var i=new URLSearchParams(window.location.search).get("l");i&&(this.map=this.game.encoder.decode(i),this.map.levelID=0)}else this.map=this.game.maps.getByLevelID(t)}locationAvailable(e,t,i){if(!this.locationExists(e,t))return!1;var s=this.getMapTile(e,t);if("player"===i&&s.obstructsPlayer||"pushBlock"===i&&s.obstructsPushBlock||"laser"===i&&s.obstructsLaser)return!1;if("laser"===i||"pushBlock"===i){if(this.game.pushBlocks.getBlockByLocation(e,t))return!1;if(this.game.pushBlocks.getBlocksMovingToLocation(e,t).length>0)return!1}if(void 0!==this.map.interactables&&void 0!==this.map.interactables.laserEmitters)for(let i of this.map.interactables.laserEmitters)if(i.position.row===e&&i.position.cell===t)return!1;return!0}locationExists(e,t){return void 0!==this.map.map[e]&&void 0!==this.map.map[e][t]}getMapTile(e,t){if(!this.locationExists(e,t))return!1;var i=this.map.map[e][t];return this.game.tiles.getByID("map",i)}getNextAvailablePositionForDirection(e,t,i,s){var l=t,a=i;switch(e){case"up":t-=1;break;case"down":t+=1;break;case"left":i-=1;break;case"right":i+=1}return this.locationAvailable(t,i,s)?{row:t,cell:i}:{row:l,cell:a}}complete(){this.game.queueNextLevel()}initialise(){this.game.pushBlocks.checkStatus()}}class Player{constructor(e){this.game=e,this.position={row:e.level.map.player.position.row,cell:e.level.map.player.position.cell},this.nextPosition={row:null,cell:null},this.speed=6,this.moving=!1}move(e){var t=Math.floor(this.position.row),i=Math.floor(this.position.cell),s=this.game.level.getNextAvailablePositionForDirection(e,t,i,"player"),l=this.speed*this.game.delta/1e3;if(null===this.nextPosition.row&&null===this.nextPosition.cell){var a=this.game.pushBlocks.getBlockByLocation(s.row,s.cell);if(void 0!==a){if(!this.game.pushBlocks.blockCanMove(e,a.id))return!1;this.game.move.add("pushBlock",a.id,e),this.moving=!0}if(this.game.pushBlocks.getBlocksMovingToLocation(s.row,s.cell).length>0)return!1;this.nextPosition.row=s.row,this.nextPosition.cell=s.cell}switch(e){case"up":if(Math.floor(this.position.row-l)<this.nextPosition.row)return this.position.row=this.nextPosition.row,this.nextPosition.row=null,this.nextPosition.cell=null,this.moving=!1,this.game.level.moves+=1,this.checkStatus(),!0;this.position.row-=l;break;case"down":if(Math.ceil(this.position.row+l)>this.nextPosition.row)return this.position.row=this.nextPosition.row,this.nextPosition.row=null,this.nextPosition.cell=null,this.moving=!1,this.game.level.moves+=1,this.checkStatus(),!0;this.position.row+=l;break;case"left":if(Math.floor(this.position.cell-l)<this.nextPosition.cell)return this.position.cell=this.nextPosition.cell,this.nextPosition.row=null,this.nextPosition.cell=null,this.moving=!1,this.game.level.moves+=1,this.checkStatus(),!0;this.position.cell-=l;break;case"right":if(Math.ceil(this.position.cell+l)>this.nextPosition.cell)return this.position.cell=this.nextPosition.cell,this.nextPosition.row=null,this.nextPosition.cell=null,this.moving=!1,this.game.level.moves+=1,this.checkStatus(),!0;this.position.cell+=l}return this.position}checkStatus(){this.checkAlive(),this.game.exit.found()&&this.game.level.complete()}checkAlive(){this.game.laser.laserExists(this.position.row,this.position.cell)&&(this.game.move.clear(),this.game.restartLevel())}}class PushBlock{constructor(e,t,i,s,l=0){this.id=e,this.row=t,this.cell=i,this.nextRow=null,this.nextCell=null,this.tile=s,this.orientation=l,this.active=!1}}class PushBlocks{constructor(e){this.game=e,this.list=[],this.allPushBlocksHome=!1,void 0!==this.game.level.map.interactables&&void 0!==this.game.level.map.interactables.pushBlocks?this.addAll():this.allPushBlocksHome=!0}addAll(){this.list=[];for(let t of this.game.level.map.interactables.pushBlocks){var e=0;void 0!==t.orientation&&(e=t.orientation),this.add(t.type,t.position.row,t.position.cell,e)}}add(e,t,i,s){var l=this.list.length,a=this.game.pushBlockTypes.getByName(e),o=this.game.tiles.getByID("pushBlock",a.tileID),h=new PushBlock(l,t,i,o,s);this.list.push(h)}getBlockByLocation(e,t){for(let i of this.list)if(i.row===e&&i.cell===t)return i}getBlocksMovingToLocation(e,t){var i=[];for(let s of this.list)s.nextRow===e&&s.nextCell===t&&i.push(s);return i}moveBlock(e,t){var i=this.getBlockByID(t),s=this.game.player.speed*this.game.delta/1e3;if(!i)return!1;var l=this.game.level.getNextAvailablePositionForDirection(e,Math.floor(i.row),Math.floor(i.cell),"pushBlock");if(null===i.nextRow&&null===i.nextCell){if(!this.blockCanMove(e,t)){if("slide"===i.tile.name){var a=l;switch(e){case"up":a.row-=1;break;case"down":a.row+=1;break;case"left":a.cell-=1;break;case"right":a.cell+=1}var o=this.getBlockByLocation(a.row,a.cell);void 0!==o&&this.game.move.add("pushBlock",o.id,e)}return!1}i.nextRow=l.row,i.nextCell=l.cell}switch(e){case"up":if(Math.floor(i.row-s)<i.nextRow)return i.row=i.nextRow,i.nextRow=null,i.nextCell=null,this.checkStatus(),"slide"===i.tile.name&&this.game.move.add("pushBlock",i.id,e),!0;i.row-=s;break;case"down":if(Math.ceil(i.row+s)>i.nextRow)return i.row=i.nextRow,i.nextRow=null,i.nextCell=null,this.checkStatus(),"slide"===i.tile.name&&this.game.move.add("pushBlock",i.id,e),!0;i.row+=s;break;case"left":if(Math.floor(i.cell-s)<i.nextCell)return i.cell=i.nextCell,i.nextRow=null,i.nextCell=null,this.checkStatus(),"slide"===i.tile.name&&this.game.move.add("pushBlock",i.id,e),!0;i.cell-=s;break;case"right":if(Math.ceil(i.cell+s)>i.nextCell)return i.cell=i.nextCell,i.nextRow=null,i.nextCell=null,this.checkStatus(),"slide"===i.tile.name&&this.game.move.add("pushBlock",i.id,e),!0;i.cell+=s}}checkStatus(){this.game.laser.updateEmitterPushBlocks(),this.game.laser.emitLasers(),this.checkAllPushBlocksHome()&&this.checkAllLaserCapturesActive()?this.game.exit.enable():this.game.exit.disable()}checkAllLaserCapturesActive(){for(let e of this.list)if("laserCapture"===e.tile.name&&!1===e.active)return!1;return!0}getBlockByID(e){for(let t of this.list)if(t.id===e)return t}deactivateAll(){for(let e of this.list)e.active=!1}blockCanMove(e,t){var i=this.getBlockByID(t);if(!i)return!1;var s=this.game.level.getNextAvailablePositionForDirection(e,i.row,i.cell,"pushBlock");return(s.row!==i.row||s.cell!==i.cell)&&(!this.getBlockByLocation(s.row,s.cell)&&!(this.getBlocksMovingToLocation(s.row,s.cell).length>0))}checkAllPushBlocksHome(){if(void 0===this.game.level.map.interactables.pushBlockHomes)return this.allPushBlocksHome=!0,!0;for(let t of this.game.level.map.interactables.pushBlockHomes){var e=!1;for(let i of this.list)i.row===t.position.row&&i.cell===t.position.cell&&(e=!0);if(!1===e)return this.allPushBlocksHome=!1,!1}return this.allPushBlocksHome=!0,!0}}class Exit{constructor(e){this.game=e,this.game.pushBlocks.allPushBlocksHome?this.enable():this.disable()}found(){var e=this.game.player.position;if(!1===this.enabled)return!1;for(let t of this.game.level.map.interactables.exits)if(t.position.row===e.row&&t.position.cell===e.cell)return!0}enable(){this.enabled=!0,this.tile=this.game.tiles.exitTiles[0]}disable(){this.enabled=!1,this.tile=this.game.tiles.exitTiles[1]}}class Laser{constructor(e){this.game=e,this.emitters=[],this.lasers=[],this.addEmitters(),this.updateEmitterPushBlocks(),this.emitLasers()}addEmitters(){if(this.emitters=[],void 0===this.game.level.map.interactables||void 0===this.game.level.map.interactables.laserEmitters)return!1;for(let e of this.game.level.map.interactables.laserEmitters)e.id=this.getNewEmitterID(),e.type="static",this.emitters.push(e)}removeEmittersByType(e){for(var t=this.emitters.length;t--;)"pushBlock"===this.emitters[t].type&&this.emitters.splice(t,1)}getNewEmitterID(){var e=0;for(let t of this.emitters)t.id>e&&(e=t.id);return e+1}updateEmitterPushBlocks(){this.removeEmittersByType("pushBlock");for(let t of this.game.pushBlocks.list)if("laser"===t.tile.name){var e="down";switch(t.orientation){case 0:e="down";break;case 90:e="left";break;case 180:e="up";break;case 270:e="right"}this.emitters.push({id:this.getNewEmitterID(),type:"pushBlock",position:{row:t.row,cell:t.cell},direction:e})}}emitLasers(){this.game.pushBlocks.deactivateAll(),this.lasers=[];for(let e of this.emitters)this.emitLaserFromEmitter(e.id)}laserExists(e,t){this.updateEmitterPushBlocks(),this.emitLasers();for(let i of this.lasers)if(i.row===e&&i.cell===t)return!0}emitLaserFromEmitter(e){var t=this.getEmitterByID(e);this.emitLaserFrom(t.position.row,t.position.cell,t.direction)}emitLaserFrom(e,t,i){switch(i){case"down":e+=1;break;case"up":e-=1;break;case"left":t-=1;break;case"right":t+=1}if(!this.game.level.locationAvailable(e,t,"laser")){var s=this.game.pushBlocks.getBlockByLocation(e,t);return void 0!==s&&("laserCapture"===s.tile.name&&(s.active=!0),"mirror"===s.tile.name&&("up"!==i&&"right"!==i||0!==s.orientation?"down"!==i&&"right"!==i||90!==s.orientation?"down"!==i&&"left"!==i||180!==s.orientation?"up"!==i&&"left"!==i||270!==s.orientation||(s.active=!0,"left"===i?this.emitLaserFrom(e,t,"down"):"up"===i&&this.emitLaserFrom(e,t,"right")):(s.active=!0,"left"===i?this.emitLaserFrom(e,t,"up"):"down"===i&&this.emitLaserFrom(e,t,"right")):(s.active=!0,"right"===i?this.emitLaserFrom(e,t,"up"):"down"===i&&this.emitLaserFrom(e,t,"left")):(s.active=!0,"right"===i?this.emitLaserFrom(e,t,"down"):"up"===i&&this.emitLaserFrom(e,t,"left")))),!1}this.lasers.push({row:e,cell:t,direction:i}),this.emitLaserFrom(e,t,i)}getEmitterByID(e){for(let t of this.emitters)if(t.id===e)return t}}class Controls{constructor(e){this.game=e,this.listen(),this.locked=!1,this.pointer={x:0,y:0},this.directions=[],this.lastDirection=null}listen(){var e=this;window.addEventListener("keydown",function(t){e.keyDown(t)}),window.addEventListener("keyup",function(t){e.keyUp(t)}),window.addEventListener("click",function(){e.click()}),document.addEventListener("mousemove",function(t){e.pointer.x=t.clientX,e.pointer.y=t.clientY})}click(){this.game.editor.enabled&&this.game.editor.click()}keyUp(e){switch(e.keyCode){case 87:case 38:for(var t=0;t<this.directions.length;t++)"up"===this.directions[t]&&this.directions.splice(t,1);break;case 83:case 40:for(t=0;t<this.directions.length;t++)"down"===this.directions[t]&&this.directions.splice(t,1);break;case 65:case 37:for(t=0;t<this.directions.length;t++)"left"===this.directions[t]&&this.directions.splice(t,1);break;case 68:case 39:for(t=0;t<this.directions.length;t++)"right"===this.directions[t]&&this.directions.splice(t,1)}}keyDown(e){if(!0!==this.locked)switch(e.keyCode){case 87:case 38:!1===this.game.paused&&!1===this.game.editor.enabled?(this.lastDirection="up",this.directions.includes("up")||this.directions.push("up")):this.upKey();break;case 83:case 40:!1===this.game.paused&&!1===this.game.editor.enabled?(this.lastDirection="down",this.directions.includes("down")||this.directions.push("down")):this.downKey();break;case 65:case 37:!1===this.game.paused&&!1===this.game.editor.enabled?(this.lastDirection="left",this.directions.includes("left")||this.directions.push("left")):this.leftKey();break;case 68:case 39:!1===this.game.paused&&!1===this.game.editor.enabled?(this.lastDirection="right",this.directions.includes("right")||this.directions.push("right")):this.rightKey();break;case 32:this.spacebarKey();break;case 27:this.escapeKey();break;case 70:this.fKey();break;case 78:this.nKey();break;case 80:this.pKey();break;case 69:this.eKey();break;case 76:this.lKey();break;case 72:this.hKey();break;case 66:this.bKey();break;case 88:this.xKey();break;case 82:this.rKey()}}upKey(){if(!1===this.game.paused){if(this.game.editor.enabled)return void this.game.editor.changeMapTile("wall")}else this.game.menu.up()}fKey(){!1===this.game.paused&&this.game.editor.enabled&&this.game.editor.changeMapTile("floor")}nKey(){!1===this.game.paused&&this.game.editor.enabled&&this.game.editor.changeMapTile("noBlockFloor")}pKey(){!1===this.game.paused&&this.game.editor.enabled&&this.game.editor.changePlayerPosition()}rKey(){!1===this.game.paused&&this.game.editor.enabled&&this.game.editor.rotateEntity()}xKey(){!1===this.game.paused&&this.game.editor.enabled&&this.game.editor.removeEntities()}eKey(){!1===this.game.paused&&this.game.editor.enabled&&this.game.editor.changeExitPosition()}lKey(){!1===this.game.paused&&this.game.editor.enabled&&this.game.editor.addLaser()}hKey(){!1===this.game.paused&&this.game.editor.enabled&&this.game.editor.addPushBlockHome()}bKey(){!1===this.game.paused&&this.game.editor.enabled&&this.game.editor.addPushBlock()}downKey(){if(!1===this.game.paused){if(this.game.editor.enabled)return void(this.game.editor.hideControls=!this.game.editor.hideControls)}else this.game.menu.down()}leftKey(){if(!1===this.game.paused){if(this.game.editor.enabled)return}else this.game.menu.left()}rightKey(){if(!1===this.game.paused){if(this.game.editor.enabled)return}else this.game.menu.right()}spacebarKey(){!1===this.game.paused?this.game.pause():this.game.menu.action()}escapeKey(){!1===this.game.paused?this.game.pause():this.game.menu.escape()}}class Menu{constructor(e){this.game=e,this.open=!1,this.selectedItem=0,this.menu={}}openMenu(e){this.open=!0,"pause"===e&&!0===this.game.editor.enabled?this.menu=this.game.menus.getMenu("editor"):this.menu=this.game.menus.getMenu(e)}closeMenu(){this.menu={},this.open=!1}up(){"levelSelect"!==this.menu.title?0===this.selectedItem?this.selectedItem=this.menu.items.length-1:this.selectedItem-=1:this.selectedItem=0}down(){"levelSelect"!==this.menu.title||0!==this.selectedItem?this.selectedItem===this.menu.items.length-1?this.selectedItem=0:this.selectedItem+=1:this.selectedItem=1}action(){switch(this.menu.title){case"pause":switch(this.menu.items[this.selectedItem].action){case"resume":!0===this.game.editor.enabled&&this.game.restartLevel(),this.game.editor.enabled=!1,this.game.pause();break;case"restart":this.game.pause(),this.game.restartLevel();break;case"levelSelect":var e=this.game.level.map.levelID;this.switchMenu("levelSelect",e);break;case"levelEditor":this.game.editor.enabled=!0,this.game.editor.start(),this.game.pause()}break;case"levelSelect":switch(this.menu.items[this.selectedItem].action){case"back":this.switchMenu("pause",2);break;default:var t=this.menu.items[this.selectedItem].action;this.game.pause(),this.game.loadLevel(t)}break;case"editor":switch(this.menu.items[this.selectedItem].action){case"exit":this.switchMenu("pause"),this.game.editor.enabled=!1;break;case"edit":this.game.pause();break;case"play":window.location.href="?l="+this.game.encoder.encode(this.game.level.map)}}}switchMenu(e,t=0){this.selectedItem=t,this.menu=this.game.menus.getMenu(e)}left(){if("levelSelect"===this.menu.title){if(0===this.selectedItem)return;1===this.selectedItem?this.selectedItem=this.menu.items.length-1:this.selectedItem-=1}}right(){"levelSelect"===this.menu.title&&(this.selectedItem===this.menu.items.length-1?this.selectedItem=1:this.selectedItem+=1)}escape(){"pause"!==this.menu.title?this.switchMenu("pause",2):this.game.pause()}}class Menus{constructor(e){this.game=e,this.items=[{title:"pause",items:[{title:"Resume",action:"resume"},{title:"Restart",action:"restart"},{title:"Level select",action:"levelSelect"},{title:"Level editor",action:"levelEditor"}]},{title:"levelSelect",items:[{title:"Back",action:"back"}]},{title:"editor",items:[{title:"Return to editor",action:"edit"},{title:"Play",action:"play"},{title:"Exit",action:"exit"}]}],this.populateLevels()}populateLevels(){var e=this.getMenu("levelSelect");for(let t of this.game.maps.list)e.items.push({title:t.levelID+". "+t.name,action:t.levelID})}getMenu(e){for(let t of this.items)if(t.title===e)return t}}class Editor{constructor(e){this.game=e,this.enabled=!1,this.hideControls=!1}start(){this.game.loadLevel(this.game.level.map.levelID)}tick(){void 0!==this.game.level.map.interactables.pushBlocks&&(this.game.pushBlocks.addAll(),this.game.laser.updateEmitterPushBlocks()),this.game.laser.emitLasers()}click(){var e=this.game.canvas.getLeftPadding(),t=e+this.game.canvas.tileSize*this.game.level.map.map[0].length,i=this.game.canvas.getTopPadding(),s=i+this.game.canvas.tileSize*this.game.level.map.map.length;if(this.game.controls.pointer.y<i)this.addRow("top");else if(this.game.controls.pointer.y>s)this.addRow("bottom");else if(this.game.controls.pointer.x<e)this.addColumn("left");else if(this.game.controls.pointer.x>t)this.addColumn("right");else{var l=this.game.controls.pointer.y-i,a=s-this.game.controls.pointer.y,o=this.game.controls.pointer.x-e,h=t-this.game.controls.pointer.x;switch(Math.min(l,a,o,h)){case l:this.removeRow("top");break;case a:this.removeRow("bottom");break;case o:this.removeColumn("left");break;case h:this.removeColumn("right")}}this.game.canvas.setDimensions()}addRow(e){switch(e){case"top":var t=JSON.parse(JSON.stringify(this.game.level.map.map[0]));this.game.level.map.map.unshift(t),this.shiftEntities("down");break;case"bottom":t=JSON.parse(JSON.stringify(this.game.level.map.map.slice(-1)[0]));this.game.level.map.map.push(t)}}shiftEntities(e){switch(e){case"down":var t=this.game.level.map.player.position.row+=1;this.game.player.position.row=t;for(let e of["pushBlockHomes","laserEmitters","pushBlocks","exits"])if(void 0!==this.game.level.map.interactables[e])for(let t of this.game.level.map.interactables[e])t.position.row+=1;break;case"up":t=this.game.level.map.player.position.row-=1;this.game.player.position.row=t;for(let e of["pushBlockHomes","laserEmitters","pushBlocks","exits"])if(void 0!==this.game.level.map.interactables[e])for(let t of this.game.level.map.interactables[e])t.position.row-=1;break;case"right":var i=this.game.level.map.player.position.cell+=1;this.game.player.position.cell=i;for(let e of["pushBlockHomes","laserEmitters","pushBlocks","exits"])if(void 0!==this.game.level.map.interactables[e])for(let t of this.game.level.map.interactables[e])t.position.cell+=1;break;case"left":i=this.game.level.map.player.position.cell-=1;this.game.player.position.cell=i;for(let e of["pushBlockHomes","laserEmitters","pushBlocks","exits"])if(void 0!==this.game.level.map.interactables[e])for(let t of this.game.level.map.interactables[e])t.position.cell-=1}}removeRow(e){if(!(this.game.level.map.map.length<=3))switch(e){case"top":if(this.entityExistsInRow(0))return;this.game.level.map.map.splice(0,1),this.shiftEntities("up");break;case"bottom":if(this.entityExistsInRow(this.game.level.map.map.length-1))return;this.game.level.map.map.splice(-1,1)}}entityExistsInColumn(e){if(this.game.player.position.cell===e)return!0;for(let t of["pushBlockHomes","laserEmitters","pushBlocks","exits"])if(void 0!==this.game.level.map.interactables[t])for(let i of this.game.level.map.interactables[t])if(i.position.cell===e)return!0}entityExistsInRow(e){if(this.game.player.position.row===e)return!0;for(let t of["pushBlockHomes","laserEmitters","pushBlocks","exits"])if(void 0!==this.game.level.map.interactables[t])for(let i of this.game.level.map.interactables[t])if(i.position.row===e)return!0}removeColumn(e){if(!(this.game.level.map.map[0].length<=3))switch(e){case"left":if(this.entityExistsInColumn(0))return;for(let e of this.game.level.map.map)e.splice(0,1);this.shiftEntities("left");break;case"right":if(this.entityExistsInColumn(this.game.level.map.map[0].length-1))return;for(let e of this.game.level.map.map)e.splice(-1,1)}}addColumn(e){switch(e){case"left":for(let e of this.game.level.map.map)e.unshift(e[0]);this.shiftEntities("right");break;case"right":for(let e of this.game.level.map.map)e.push(e.slice(-1)[0])}}changeMapTile(e){var t=this.getFocussedTile();if(void 0!==t){var i=this.game.tiles.getMapTileByName(e);this.game.level.map.map[t.y][t.x]=i.id}}changePlayerPosition(){var e=this.getFocussedTile();void 0!==e&&(this.game.level.map.player.position={row:e.y,cell:e.x},this.game.player.position=this.game.level.map.player.position)}changeExitPosition(){var e=this.getFocussedTile();void 0!==e&&(this.game.level.map.interactables.exits[0].position={row:e.y,cell:e.x})}addLaser(){var e=this.getFocussedTile();if(void 0!==e){var t=this.game.level.map.interactables.laserEmitters;if(void 0===t)return this.game.level.map.interactables.laserEmitters=[],this.game.level.map.interactables.laserEmitters.push({position:{row:e.y,cell:e.x},direction:"down"}),void this.game.laser.addEmitters();for(let i of t)if(i.position.row===e.y&&i.position.cell===e.x)return;t.push({position:{row:e.y,cell:e.x},direction:"down"}),this.game.laser.addEmitters()}}rotateEntity(){var e=this.getFocussedTile();if(void 0!==e){var t=this.game.pushBlocks.getBlockByLocation(e.y,e.x);if(void 0!==t)for(let e of this.game.level.map.interactables.pushBlocks)if(e.position.row===t.row&&e.position.cell===t.cell){var i=(e.orientation||0)+90;return i>270&&(i=0),void(e.orientation=i)}var s=this.game.level.map.interactables.laserEmitters;if(void 0!==s)for(let t of s)if(t.position.row===e.y&&t.position.cell===e.x)switch(t.direction){case"down":t.direction="left";break;case"left":t.direction="up";break;case"up":t.direction="right";break;case"right":t.direction="down"}}}addPushBlockHome(){var e=this.getFocussedTile();if(void 0!==e){var t=this.game.level.map.interactables.pushBlockHomes;if(void 0===t)return this.game.level.map.interactables.pushBlockHomes=[],void this.game.level.map.interactables.pushBlockHomes.push({position:{row:e.y,cell:e.x}});for(let i of t)if(i.position.row===e.y&&i.position.cell===e.x)return;t.push({position:{row:e.y,cell:e.x}})}}cyclePushBlock(e){for(var t=this.game.pushBlocks.getBlockByLocation(e.y,e.x),i=this.game.tiles.pushBlockTiles.length;i--;)if(this.game.tiles.pushBlockTiles[i].id===t.tile.id){var s=i+1;s>=this.game.tiles.pushBlockTiles.length&&(s=0);var l=this.game.tiles.pushBlockTiles[s];for(let t of this.game.pushBlockTypes.list)if(t.tileID===l.id){for(let i of this.game.level.map.interactables.pushBlocks)i.position.row===e.y&&i.position.cell===e.x&&(i.type=t.name);return}}}removeEntities(){var e=this.getFocussedTile();if(void 0!==e)if(void 0===this.game.pushBlocks.getBlockByLocation(e.y,e.x)){var t=this.game.level.map.interactables.pushBlockHomes;if(void 0!==t)for(var i=t.length;i--;)if(t[i].position.row===e.y&&t[i].position.cell===e.x)return void t.splice(i,1);var s=this.game.level.map.interactables.laserEmitters;if(void 0!==s)for(var l=s.length;l--;)if(s[l].position.row===e.y&&s[l].position.cell===e.x){s.splice(l,1);for(var a=this.game.laser.emitters,o=a.length;o--;)a[o].position.row===e.y&&a[o].position.cell===e.x&&a.splice(o,1);return}}else for(var h=this.game.pushBlocks.list.length;h--;)if(this.game.pushBlocks.list[h].row===e.y&&this.game.pushBlocks.list[h].cell===e.x){this.game.pushBlocks.list.splice(h,1);for(var r=this.game.level.map.interactables.pushBlocks,c=r.length;c--;)if(r[c].position.row===e.y&&r[c].position.cell===e.x){r[c].type;r.splice(c,1)}}}addPushBlock(){var e=this.getFocussedTile();void 0!==e&&(void 0===this.game.pushBlocks.getBlockByLocation(e.y,e.x)?(void 0===this.game.level.map.interactables.pushBlocks&&(this.game.level.map.interactables.pushBlocks=[]),this.game.level.map.interactables.pushBlocks.push({type:"default",position:{row:e.y,cell:e.x}}),this.game.pushBlocks.add("default",e.y,e.x,0)):this.cyclePushBlock(e))}getFocussedTile(){var e=this.game.canvas.getLeftPadding(),t=e+this.game.canvas.tileSize*this.game.level.map.map[0].length,i=this.game.canvas.getTopPadding(),s=i+this.game.canvas.tileSize*this.game.level.map.map.length;if(this.game.controls.pointer.x>e&&this.game.controls.pointer.x<t&&this.game.controls.pointer.y>i&&this.game.controls.pointer.y<s)return{x:Math.floor((this.game.controls.pointer.x-e)/this.game.canvas.tileSize),y:Math.floor((this.game.controls.pointer.y-i)/this.game.canvas.tileSize)}}}class Canvas{constructor(e){this.game=e,this.tileSize=64,this.c=document.getElementById("canvas"),this.ctx=this.c.getContext("2d"),this.setDimensions()}getPlayableAreaDimensions(){var e=this.game.level.map.map,t=e.length*this.tileSize;return{width:e[0].length*this.tileSize,height:t}}getLeftPadding(){return this.c.width/2-this.getPlayableAreaDimensions().width/2}getTopPadding(){return this.c.height/2-this.getPlayableAreaDimensions().height/2}setDimensions(){if(this.c.height=this.c.clientHeight,this.c.width=this.c.clientWidth,this.tileSize=64,this.getPlayableAreaDimensions().width>this.c.width||this.getPlayableAreaDimensions().height>this.c.height){var e=this.game.level.map.map,t=e.length,i=e[0].length,s=this.c.width/i,l=this.c.height/t;l<s&&l<this.tileSize?this.tileSize=Math.floor(l):s<this.tileSize&&(this.tileSize=Math.floor(s))}}drawFrame(){this.drawLevel(),this.drawPlayer(),this.drawControls(),this.drawEditor(),this.drawMenu()}drawControls(){if(!0!==this.game.editor.enabled){if(!(this.game.level.map.levelID>1||Date.now()-this.game.level.startTime<4e3||null!==this.game.controls.lastDirection)){var e=this.tileSize/2;this.ctx.textAlign="center",this.ctx.font=e+"px Arial",this.ctx.fillStyle="rgba(0, 0, 0, 0.5)";for(var t="Press W, A, S, D or UP, LEFT, DOWN, RIGHT to move",i=this.ctx.measureText(t).width;i>this.c.width-this.tileSize;)e-=1,this.ctx.font=e+"px Arial",i=this.ctx.measureText(t).width;this.ctx.fillText(t,this.c.width/2,this.c.height-2*e)}}else this.drawEditorControls()}drawEditorControls(){if(!0!==this.game.editor.hideControls){var e=this.tileSize/2;this.ctx.textAlign="center",this.ctx.font=e+"px Arial",this.ctx.fillStyle="rgba(0, 0, 0, 0.5)";for(var t="[F]loor, [W]all, [P]layer, [E]xit, [B]lock, [L]aser, [R]otate, [H]ome, [S]how/hide controls, [CLICK] resize",i=this.ctx.measureText(t).width;i>this.c.width-this.tileSize;)e-=1,this.ctx.font=e+"px Arial",i=this.ctx.measureText(t).width;this.ctx.fillText(t,this.c.width/2,this.c.height-2*e)}}drawEditor(){if(!1!==this.game.editor.enabled){this.ctx.strokeStyle="rgba(0,0,0,0.2)",this.ctx.lineWidth=1;for(var e=0;e<this.game.level.map.map.length;e++)for(var t=0;t<this.game.level.map.map[e].length;t++)this.ctx.strokeRect(this.getLeftPadding()+this.tileSize*t,this.getTopPadding()+this.tileSize*e,this.tileSize,this.tileSize);var i=this.game.editor.getFocussedTile();this.ctx.lineWidth=this.tileSize/16,this.ctx.strokeStyle="rgba(0,0,0,0.2)",i&&this.ctx.strokeRect(this.getLeftPadding()+this.tileSize*i.x+this.ctx.lineWidth/2,this.getTopPadding()+this.tileSize*i.y+this.ctx.lineWidth/2,this.tileSize-this.ctx.lineWidth,this.tileSize-this.ctx.lineWidth)}}drawMenu(){if(!1!==this.game.menu.open){this.ctx.fillStyle=this.game.tiles.playerTiles[0].colour,this.ctx.fillRect(0,0,this.c.clientWidth,this.c.clientHeight),this.ctx.textAlign="left";var e=this.tileSize;switch(this.ctx.font=e+"px Arial",this.game.menu.menu.title){case"pause":case"editor":for(var t=0;t<this.game.menu.menu.items.length;t++){var i=.5;this.game.menu.selectedItem===t&&(i=1),this.ctx.fillStyle="rgba(255, 255, 255, "+i+")",this.ctx.fillText(this.game.menu.menu.items[t].title,e,e*(t+1.5))}break;case"levelSelect":i=.5;0===this.game.menu.selectedItem&&(i=1),this.ctx.fillStyle="rgba(255, 255, 255, "+i+")",this.ctx.fillText(this.game.menu.menu.items[0].title,e,1.5*e);var s=[];for(let e of this.game.menu.menu.items)isNaN(e.action)||s.push(e);for(t=1;t<this.game.menu.menu.items.length;t++){var l=!1;this.game.menu.selectedItem===t&&(l=!0);var a=this.tileSize,o=(this.c.width-2*a)/s.length;l&&(this.ctx.fillStyle="rgba(255, 255,255 0.3)",this.ctx.fillRect(a+o*(t-1)+this.tileSize/8,2*e,o-this.tileSize/8,o-this.tileSize/8)),this.ctx.strokeStyle="#ffffff",this.ctx.lineWidth=3,this.ctx.strokeRect(a+o*(t-1)+this.tileSize/8,2*e,o-this.tileSize/8,o-this.tileSize/8)}this.ctx.fillStyle="#ffffff";var h=this.game.menu.selectedItem;t=this.game.menu.menu.items[h];if(0!==this.game.menu.selectedItem&&this.ctx.fillText(t.title,e,5*e),void 0!==this.game.stats.levels[t.action]){var r=this.game.stats.levels[t.action],c=parseInt(r.time%1e3/100),n=parseInt(r.time/1e3%60),m=parseInt(r.time/6e4%60);m=m<10?"0"+m:m,n=n<10?"0"+n:n,this.ctx.font=e/2+"px Arial",this.ctx.fillText("Fewest moves: "+r.moves,e,6*e),this.ctx.fillText("Fastest time: "+m+":"+n+"."+c,e,7*e)}}}}drawLevel(){this.drawBackground(),this.drawMap(),this.drawExits(),this.drawPushBlockHomes(),this.drawLasers(),this.drawPushBlocks()}drawBackground(){this.ctx.fillStyle=this.game.tiles.getByID("map",1).colour,this.ctx.fillRect(0,0,this.c.clientWidth,this.c.clientHeight)}drawPlayer(){var e=this.game.tiles.getPlayerTile(),t=this.game.player.position.row*this.tileSize,i=this.game.player.position.cell*this.tileSize;this.drawTile(e.colour,t,i)}drawMap(){for(var e=this.game.level.map,t=0;t<e.map.length;t++)for(var i=e.map[t],s=0;s<i.length;s++){var l=i[s];this.drawMapTile(l,t,s)}}drawLevelComplete(){var e=this.game.timer.count("levelComplete",1e3);if(!0===e.completed)return!0;this.ctx.fillStyle="rgba(255, 255, 255, "+e.elapsedPercent/100+")",this.ctx.fillRect(0,0,this.c.clientWidth,this.c.clientHeight)}drawLevelBegin(){var e=this.game.timer.count("levelBegin",1e3);if(!0===e.completed)return!0;this.ctx.fillStyle="rgba(255, 255, 255, "+e.remainingPercent/100+")",this.ctx.fillRect(0,0,this.c.clientWidth,this.c.clientHeight)}drawPushBlocks(){for(let s of this.game.pushBlocks.list){var e=s.row*this.tileSize,t=s.cell*this.tileSize;if("laser"===s.tile.name||"mirror"===s.tile.name){var i="down";switch(s.orientation){case 0:i="down";break;case 90:i="left";break;case 180:i="up";break;case 270:i="right"}}switch(s.tile.name){case"laser":this.drawLaserEmitter(s.tile.colour,e,t,i);break;case"laserCapture":this.drawLaserCapture(s.tile.colour,e,t,s.active);break;case"mirror":this.drawMirror(s.tile.colour,s.tile.detailColour,e,t,i,s.active);break;case"slide":this.drawSlideBlock(s.tile.colour,s.tile.detailColour,e,t,i,s.active);break;default:this.drawTile(s.tile.colour,e,t)}}}drawPushBlockHomes(){if(void 0===this.game.level.map.interactables||void 0===this.game.level.map.interactables.pushBlockHomes)return!1;for(let s of this.game.level.map.interactables.pushBlockHomes){var e=s.position.row*this.tileSize,t=s.position.cell*this.tileSize,i=this.game.tiles.pushBlockHomeTiles[0].colour;this.drawTileOutline(i,e,t)}}drawExits(){for(let s of this.game.level.map.interactables.exits){var e=s.position.row*this.tileSize,t=s.position.cell*this.tileSize,i=this.game.exit.tile.colour;this.drawTileOutline(i,e,t)}}drawLasers(){this.drawLaserEmitters(),this.drawLaserLines()}drawLaserLines(){for(let e of this.game.laser.lasers)this.drawTileLine(e.direction,this.tileSize/11,this.getLaserColour(),e.row*this.tileSize,e.cell*this.tileSize)}drawLaserEmitters(){if(void 0===this.game.level.map.interactables||void 0===this.game.level.map.interactables.laserEmitters)return!1;for(let s of this.game.level.map.interactables.laserEmitters){var e=s.position.row*this.tileSize,t=s.position.cell*this.tileSize,i=this.game.tiles.laserTiles[0];this.drawLaserEmitter(i.colour,e,t,s.direction)}}tileSizePercent(e){return e/100*this.tileSize}drawLaserCapture(e,t,i,s){t+=this.getTopPadding(),i+=this.getLeftPadding(),this.ctx.fillStyle=this.getLaserColour(),!0===s&&(this.ctx.beginPath(),this.ctx.moveTo(i+this.tileSizePercent(50),t+this.tileSizePercent(35)),this.ctx.lineTo(i+this.tileSizePercent(65),t+this.tileSizePercent(50)),this.ctx.lineTo(i+this.tileSizePercent(50),t+this.tileSizePercent(65)),this.ctx.lineTo(i+this.tileSizePercent(35),t+this.tileSizePercent(50)),this.ctx.fill()),this.ctx.fillStyle=e,this.ctx.beginPath(),this.ctx.moveTo(i,t),this.ctx.lineTo(i+this.tileSizePercent(80),t),this.ctx.lineTo(i,t+this.tileSizePercent(80)),this.ctx.fill(),this.ctx.beginPath(),this.ctx.moveTo(i+this.tileSize,t),this.ctx.lineTo(i+this.tileSizePercent(20),t),this.ctx.lineTo(i+this.tileSize,t+this.tileSizePercent(80)),this.ctx.fill(),this.ctx.beginPath(),this.ctx.moveTo(i,t+this.tileSize),this.ctx.lineTo(i+this.tileSizePercent(80),t+this.tileSize),this.ctx.lineTo(i,t+this.tileSizePercent(20)),this.ctx.fill(),this.ctx.beginPath(),this.ctx.moveTo(i+this.tileSize,t+this.tileSize),this.ctx.lineTo(i+this.tileSizePercent(20),t+this.tileSize),this.ctx.lineTo(i+this.tileSize,t+this.tileSizePercent(20)),this.ctx.fill()}getLaserColour(){var e=this.game.timer.count("laserColour",1e3,!0).elapsedPercent/100;return"rgba(204, 0, 0, "+(e=.5+e/6)+")"}drawLaserEmitter(e,t,i,s){switch(t+=this.getTopPadding(),i+=this.getLeftPadding(),s){case"up":this.ctx.fillStyle=this.getLaserColour(),this.ctx.beginPath(),this.ctx.moveTo(Math.floor(i+this.tileSizePercent(36)),Math.floor(t)),this.ctx.lineTo(Math.floor(i+this.tileSizePercent(50)),Math.floor(t+this.tileSizePercent(16))),this.ctx.lineTo(Math.floor(i+this.tileSizePercent(63)),Math.floor(t)),this.ctx.fill(),this.ctx.fillStyle=e,this.ctx.beginPath(),this.ctx.moveTo(Math.floor(i),Math.floor(t)),this.ctx.lineTo(Math.floor(i),Math.floor(t+this.tileSize)),this.ctx.lineTo(Math.floor(i+this.tileSize),Math.floor(t+this.tileSize)),this.ctx.lineTo(Math.floor(i+this.tileSize),Math.floor(t)),this.ctx.lineTo(Math.floor(i+this.tileSizePercent(66)),Math.floor(t)),this.ctx.lineTo(Math.floor(i+this.tileSizePercent(50)),Math.floor(t+this.tileSizePercent(20))),this.ctx.lineTo(Math.floor(i+this.tileSizePercent(33)),Math.floor(t));break;case"down":this.ctx.fillStyle=this.getLaserColour(),this.ctx.beginPath(),this.ctx.moveTo(Math.floor(i+this.tileSizePercent(36)),Math.floor(t+this.tileSize)),this.ctx.lineTo(Math.floor(i+this.tileSizePercent(50)),Math.floor(t+this.tileSizePercent(84))),this.ctx.lineTo(Math.floor(i+this.tileSizePercent(63)),Math.floor(t+this.tileSize)),this.ctx.fill(),this.ctx.fillStyle=e,this.ctx.beginPath(),this.ctx.moveTo(Math.floor(i),Math.floor(t)),this.ctx.lineTo(Math.floor(i),Math.floor(t+this.tileSize)),this.ctx.lineTo(Math.floor(i+this.tileSizePercent(33)),Math.floor(t+this.tileSize)),this.ctx.lineTo(Math.floor(i+this.tileSizePercent(50)),Math.floor(t+this.tileSizePercent(80))),this.ctx.lineTo(Math.floor(i+this.tileSizePercent(66)),Math.floor(t+this.tileSize)),this.ctx.lineTo(Math.floor(i+this.tileSize),Math.floor(t+this.tileSize)),this.ctx.lineTo(Math.floor(i+this.tileSize),Math.floor(t));break;case"left":this.ctx.fillStyle=this.getLaserColour(),this.ctx.beginPath(),this.ctx.moveTo(Math.floor(i),Math.floor(t+this.tileSizePercent(36))),this.ctx.lineTo(Math.floor(i+this.tileSizePercent(16)),Math.floor(t+this.tileSizePercent(50))),this.ctx.lineTo(Math.floor(i),Math.floor(t+this.tileSizePercent(63))),this.ctx.fill(),this.ctx.fillStyle=e,this.ctx.beginPath(),this.ctx.moveTo(Math.floor(i),Math.floor(t)),this.ctx.lineTo(Math.floor(i),Math.floor(t+this.tileSizePercent(33))),this.ctx.lineTo(Math.floor(i+this.tileSizePercent(20)),Math.floor(t+this.tileSizePercent(50))),this.ctx.lineTo(Math.floor(i),Math.floor(t+this.tileSizePercent(66))),this.ctx.lineTo(Math.floor(i),Math.floor(t+this.tileSize)),this.ctx.lineTo(Math.floor(i+this.tileSize),Math.floor(t+this.tileSize)),this.ctx.lineTo(Math.floor(i+this.tileSize),Math.floor(t));break;case"right":this.ctx.fillStyle=this.getLaserColour(),this.ctx.beginPath(),this.ctx.moveTo(Math.floor(i+this.tileSize),Math.floor(t+this.tileSizePercent(36))),this.ctx.lineTo(Math.floor(i+this.tileSizePercent(84)),Math.floor(t+this.tileSizePercent(50))),this.ctx.lineTo(Math.floor(i+this.tileSize),Math.floor(t+this.tileSizePercent(63))),this.ctx.fill(),this.ctx.fillStyle=e,this.ctx.beginPath(),this.ctx.moveTo(Math.floor(i),Math.floor(t)),this.ctx.lineTo(Math.floor(i),Math.floor(t+this.tileSize)),this.ctx.lineTo(Math.floor(i+this.tileSize),Math.floor(t+this.tileSize)),this.ctx.lineTo(Math.floor(i+this.tileSize),Math.floor(t+this.tileSizePercent(66))),this.ctx.lineTo(Math.floor(i+this.tileSizePercent(80)),Math.floor(t+this.tileSizePercent(50))),this.ctx.lineTo(Math.floor(i+this.tileSize),Math.floor(t+this.tileSizePercent(33))),this.ctx.lineTo(Math.floor(i+this.tileSize),Math.floor(t))}this.ctx.fill()}drawSlideBlock(e,t,i,s,l,a){this.drawTile(t,i,s),this.ctx.fillStyle=e,i+=this.getTopPadding(),s+=this.getLeftPadding(),this.ctx.fillRect(Math.floor(s),Math.floor(i),Math.floor(this.tileSizePercent(7)),Math.floor(this.tileSize)),this.ctx.fillRect(Math.floor(s+Math.ceil(this.tileSizePercent(93))),Math.floor(i),Math.floor(this.tileSizePercent(7)),Math.floor(this.tileSize)),this.ctx.fillRect(Math.floor(s),Math.floor(i),Math.floor(this.tileSize),Math.floor(this.tileSizePercent(7))),this.ctx.fillRect(Math.floor(s),Math.floor(i+Math.ceil(this.tileSizePercent(93))),Math.floor(this.tileSize),Math.floor(this.tileSizePercent(7))),this.ctx.beginPath(),this.ctx.moveTo(Math.floor(s+this.tileSizePercent(30)),Math.floor(i)),this.ctx.lineTo(Math.floor(s),Math.floor(i+this.tileSizePercent(30))),this.ctx.lineTo(Math.floor(s),Math.floor(i+this.tileSizePercent(60))),this.ctx.lineTo(Math.floor(s)+this.tileSizePercent(60),Math.floor(i)),this.ctx.fill(),this.ctx.beginPath(),this.ctx.moveTo(Math.floor(s+this.tileSizePercent(85)),Math.floor(i)),this.ctx.lineTo(Math.floor(s),Math.floor(i+this.tileSizePercent(85))),this.ctx.lineTo(Math.floor(s),Math.floor(i+this.tileSize)),this.ctx.lineTo(Math.floor(s+this.tileSizePercent(15)),Math.floor(i+this.tileSize)),this.ctx.lineTo(Math.floor(s+this.tileSize),Math.floor(i+this.tileSizePercent(15))),this.ctx.lineTo(Math.floor(s+this.tileSize),Math.floor(i)),this.ctx.fill(),this.ctx.beginPath(),this.ctx.moveTo(Math.floor(s+this.tileSize),Math.floor(i+this.tileSizePercent(40))),this.ctx.lineTo(Math.floor(s+this.tileSizePercent(40)),Math.floor(i+this.tileSize)),this.ctx.lineTo(Math.floor(s+this.tileSizePercent(70)),Math.floor(i+this.tileSize)),this.ctx.lineTo(Math.floor(s+this.tileSize),Math.floor(i+this.tileSizePercent(70))),this.ctx.fill()}drawMirror(e,t,i,s,l,a){switch(this.drawTile(t,i,s),!0===a&&(this.drawTileLine("up",this.tileSize/11,this.getLaserColour(),i,s),this.drawTileLine("left",this.tileSize/11,this.getLaserColour(),i,s)),i+=this.getTopPadding(),s+=this.getLeftPadding(),this.ctx.fillStyle=e,this.ctx.fillRect(Math.floor(s),Math.floor(i),Math.floor(this.tileSizePercent(7)),Math.floor(this.tileSize)),this.ctx.fillRect(Math.floor(s+Math.ceil(this.tileSizePercent(93))),Math.floor(i),Math.floor(this.tileSizePercent(7)),Math.floor(this.tileSize)),this.ctx.fillRect(Math.floor(s),Math.floor(i),Math.floor(this.tileSize),Math.floor(this.tileSizePercent(7))),this.ctx.fillRect(Math.floor(s),Math.floor(i+Math.ceil(this.tileSizePercent(93))),Math.floor(this.tileSize),Math.floor(this.tileSizePercent(7))),l){case"up":this.ctx.beginPath(),this.ctx.moveTo(Math.floor(s),Math.floor(i)),this.ctx.lineTo(Math.floor(s),Math.floor(i+this.tileSize)),this.ctx.lineTo(Math.floor(s+this.tileSize),Math.floor(i+this.tileSize));break;case"down":this.ctx.beginPath(),this.ctx.moveTo(Math.floor(s),Math.floor(i)),this.ctx.lineTo(Math.floor(s+this.tileSize),Math.floor(i)),this.ctx.lineTo(Math.floor(s+this.tileSize),Math.floor(i+this.tileSize));break;case"left":this.ctx.beginPath(),this.ctx.moveTo(Math.floor(s),Math.floor(i+this.tileSize)),this.ctx.lineTo(Math.floor(s+this.tileSize),Math.floor(i)),this.ctx.lineTo(Math.floor(s+this.tileSize),Math.floor(i+this.tileSize));break;case"right":this.ctx.beginPath(),this.ctx.moveTo(Math.floor(s),Math.floor(i)),this.ctx.lineTo(Math.floor(s),Math.floor(i+this.tileSize)),this.ctx.lineTo(Math.floor(s+this.tileSize),Math.floor(i))}this.ctx.fill()}drawMapTile(e,t,i){if(void 0===e)return!1;var s=this.game.tiles.getByID("map",e),l=t*this.tileSize,a=i*this.tileSize;this.drawTile(s.colour,l,a)}drawTile(e,t,i){this.ctx.fillStyle=e,this.ctx.fillRect(Math.floor(i+this.getLeftPadding()),Math.floor(t+this.getTopPadding()),Math.floor(this.tileSize),Math.floor(this.tileSize))}drawTileLine(e,t,i,s,l){s+=this.getTopPadding(),l+=this.getLeftPadding(),this.ctx.strokeStyle=i,this.ctx.lineWidth=t,this.ctx.beginPath(),"up"===e||"down"===e?(this.ctx.moveTo(Math.floor(l+this.tileSize/2),Math.floor(s)),this.ctx.lineTo(Math.floor(l+this.tileSize/2),Math.floor(s+this.tileSize))):(this.ctx.moveTo(Math.floor(l),Math.floor(s+this.tileSize/2)),this.ctx.lineTo(Math.floor(l+this.tileSize),Math.floor(s+this.tileSize/2))),this.ctx.stroke()}drawTileOutline(e,t,i){this.ctx.fillStyle=e,t+=this.getTopPadding(),i+=this.getLeftPadding(),this.ctx.fillRect(Math.floor(i+Math.ceil(this.tileSizePercent(10))),Math.floor(t+Math.ceil(this.tileSizePercent(10))),Math.floor(this.tileSizePercent(10)),Math.floor(this.tileSizePercent(80))),this.ctx.fillRect(Math.floor(i+Math.ceil(this.tileSizePercent(80))),Math.floor(t+Math.ceil(this.tileSizePercent(10))),Math.floor(this.tileSizePercent(10)),Math.floor(this.tileSizePercent(80))),this.ctx.fillRect(Math.floor(i+Math.ceil(this.tileSizePercent(10))),Math.floor(t+Math.ceil(this.tileSizePercent(10))),Math.floor(this.tileSizePercent(80)),Math.floor(this.tileSizePercent(10))),this.ctx.fillRect(Math.floor(i+Math.ceil(this.tileSizePercent(10))),Math.floor(t+Math.ceil(this.tileSizePercent(80))),Math.floor(this.tileSizePercent(80)),Math.floor(this.tileSizePercent(10)))}}class Game{constructor(){var e=1;new URLSearchParams(window.location.search).get("l")&&(e=0),this.maps=new Maps(this),this.tiles=new Tiles,this.pushBlockTypes=new PushBlockTypes,this.timer=new Timer,this.stats=new Stats(this),this.move=new Move(this),this.encoder=new Encoder(this),this.level=new Level(this,e),this.player=new Player(this),this.pushBlocks=new PushBlocks(this),this.exit=new Exit(this),this.laser=new Laser(this),this.controls=new Controls(this),this.menus=new Menus(this),this.menu=new Menu(this),this.editor=new Editor(this),this.canvas=new Canvas(this),this.tickFrame=0,this.lastTickUpdate=Date.now(),this.delta=0,this.paused=!1,this.nextLevelQueued=!1,this.level.initialise()}run(){var e=this;this.loop=setInterval(function(){e.tick()},0)}pause(){!1===this.paused?(this.paused=!0,this.menu.openMenu("pause")):(this.paused=!1,this.menu.closeMenu())}tick(){var e=Date.now();this.delta=e-this.lastTickUpdate,this.lastTickUpdate=e,this.tickFrame++,this.canvas.drawFrame(),this.editor.enabled?this.editor.tick():(!1===this.paused&&this.move.move(),this.nextLevelQueued&&this.loadNextLevel(),!0===this.level.begin&&!0===this.canvas.drawLevelBegin()&&(this.level.begin=!1),this.player.checkAlive())}queueNextLevel(){this.controls.locked=!0,this.nextLevelQueued=!0,this.stats.add()}loadNextLevel(){if(!0===this.canvas.drawLevelComplete()){this.nextLevelQueued=!1;var e=this.level.map.levelID+1;this.maps.getByLevelID(e)||(e=1),this.loadLevel(e)}}restartLevel(){this.loadLevel(this.level.map.levelID)}loadLevel(e){this.move=new Move(this),this.level=new Level(this,e),this.player=new Player(this),this.pushBlocks=new PushBlocks(this),this.exit=new Exit(this),this.laser=new Laser(this),this.menus=new Menus(this),this.menu=new Menu(this),this.canvas=new Canvas(this),this.controls.locked=!1,this.level.initialise()}}var game=new Game;window.onresize=function(e){game.canvas.setDimensions()},game.run();